# Protocol Submodule

This package provides functionality for packing and unpacking the various
protocols used by the Waggle platform.

## Core Protocol Data Types

The Waggle platform implements a variety of data types, each used for a specific
layer of the message pipeline. The typical data flow looks like:

1. Plugin publishes **sensorgrams**.
2. Node bundles **sensorgrams** and plugin info into **datagram**.
3. Node bundles **datagrams** with sender and receiver info into **waggle message**.

The resulting waggle message, depicted visually, would be organized like:

```
+-------------------------+
| waggle message          |
| sender-info: node123    |
| receiver-info: beehive  |
| datagrams:              |
| +---------------------+ |
| | datagram 1          | |
| | plugin-info: sysmon | |
| | sensorgrams:        | |
| | +---------------+   | |
| | | measurement 1 |   | |
| | | measurement 2 |   | |
| | | ...           |   | |
| | | measurement n |   | |
| | +---------------+   | |
| +---------------------+ |
| ...more datagrams...    |
+-------------------------+
```

### Sensorgram

Sensorgrams capture information about a measurement. Specifically, they provide
support for:

* Timestamp
* Sensor ID
* Sensor Instance
* Parameter ID
* Value
* Value Type

### Datagram

### Waggle Message

## Core Protocol API

### waggle.protocol

#### pack_sensorgram(sensorgram)

Pack a dictionary into a sensorgram. The supported fields are:

* `sensor_id` **required** Sensor ID.
* `parameter_id` **required** Parameter ID.
* `value` **required** Measurement value.
* `timestamp` **optional** Seconds since epoch. Default is current time.
* `sensor_instance` **optional** Sensor instance. Default is 0.
* `type` **optional** Value type. Derived from value's Python type if not specified.

#### unpack_sensorgram(data)

Unpacks a sensorgram into a dictionary.

#### pack_sensorgrams(list_of_sensorgrams)

Packs a list of sensorgrams into a stream of sensorgram bytes.

#### unpack_sensorgrams(data)

Unpacks a stream of sensorgram bytes into a list of dictionaries.

#### pack_datagram(datagram)

Packs a dictionary into a datagram. The supported fields are:

* `plugin_id` **required** Plugin ID.
* `plugin_major_version` **required** Plugin major version.
* `plugin_minor_version` **optional** Plugin minor version. Default is 0.
* `plugin_patch_version` **optional** Plugin patch version. Default is 0.
* `plugin_instance` **optional** Plugin instance. Default is 0.
* `plugin_run_id` **optional** Plugin unique run ID. Automatically generated by module.
* `packet_type` **optional** Packet type. Default is 0.
* `packet_seq` **optional** Packet sequence number. Automatically incremented by module.
* `body` **required** Payload bytes of body.

#### unpack_datagram(data)

Unpacks a datagram into a dictionary.

#### pack_message(message)

Packs a dictionary into a waggle message.

#### unpack_message(data)

Unpacks a waggle message into a dictionary.

## Basic Example

In our simplest example, we'll test packing and then unpacking some made up
sensorgrams.

```python
import waggle.protocol

sensorgrams = [
    {'sensor_id': 1, 'parameter_id': 0, 'value': 10},
    {'sensor_id': 2, 'parameter_id': 0, 'value': 22.1},
    {'sensor_id': 3, 'parameter_id': 0, 'value': b'blob of bytes'},
    {'sensor_id': 3, 'parameter_id': 1, 'value': 'string'},
    {'sensor_id': 4, 'parameter_id': 0, 'value': True, 'sensor_instance': 0},
    {'sensor_id': 4, 'parameter_id': 1, 'value': False, 'sensor_instance': 0},
    {'sensor_id': 4, 'parameter_id': 2, 'value': None, 'sensor_instance': 1},
]

# First, we'll pack some data of many different types.
data = waggle.protocol.pack_sensorgrams(sensorgrams)

# Now, we'll unpack and print all of that data.
print(waggle.protocol.unpack_sensorgrams(data))
```
